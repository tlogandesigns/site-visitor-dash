<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - New Homes Lead Tracker</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --cabernet: #670038;
            --cabernet-light: #8a0049;
            --cabernet-dark: #4a0028;
        }

        body {
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: var(--cabernet) !important;
        }

        .btn-primary {
            background-color: var(--cabernet);
            border-color: var(--cabernet);
        }

        .btn-primary:hover {
            background-color: var(--cabernet-light);
            border-color: var(--cabernet-light);
        }

        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .chart-card {
            min-height: 350px;
        }

        .chart-card canvas {
            max-height: 300px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-house-door"></i> New Homes Lead Tracker
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="analytics.html">
                            <i class="bi bi-graph-up"></i> Analytics
                        </a>
                    </li>
                    <li class="nav-item" id="usersNavItem" style="display: none;">
                        <a class="nav-link" href="index.html#users">
                            <i class="bi bi-people"></i> Users
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center text-white">
                    <span class="me-3">
                        <i class="bi bi-person-circle"></i> <span id="currentUsername">...</span>
                    </span>
                    <button class="btn btn-outline-light btn-sm" onclick="handleLogout()">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row mb-3">
            <div class="col-md-8">
                <h2><i class="bi bi-graph-up"></i> Analytics Dashboard</h2>
                <p class="text-muted">Visual insights and performance metrics for your leads</p>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2">
                    <select class="form-select" id="siteFilter" onchange="loadAnalytics()">
                        <option value="">All Sites</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadAnalytics()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Row 1: Time-based Charts -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card chart-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-calendar3"></i> Leads Over Time (Last 30 Days)
                        </h5>
                        <canvas id="leadsByDayChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card chart-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-arrow-repeat"></i> CINC Sync Status
                        </h5>
                        <canvas id="syncStatsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Distribution Charts -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card chart-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-clock-history"></i> Leads by Purchase Timeline
                        </h5>
                        <canvas id="leadsByTimelineChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card chart-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-currency-dollar"></i> Leads by Price Range
                        </h5>
                        <canvas id="leadsByPriceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Site & Agent Performance -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card chart-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-geo-alt"></i> Leads by Site/Community
                        </h5>
                        <canvas id="leadsBySiteChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6" id="agentChartContainer" style="display: none;">
                <div class="card chart-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-person-badge"></i> Leads by Agent
                        </h5>
                        <canvas id="leadsByAgentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-bar-chart-line"></i> Summary Statistics
                        </h5>
                        <div class="row text-center" id="summaryStats">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Printable Report -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-printer"></i> Printable Visitor Report
                            </h5>
                            <span class="text-muted small" id="reportScopeText">Generate a date-bound summary for all communities.</span>
                        </div>
                        <div id="reportError" class="alert alert-danger d-none" role="alert"></div>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label for="reportStartDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="reportStartDate">
                            </div>
                            <div class="col-md-3">
                                <label for="reportEndDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="reportEndDate">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-block">Actions</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-secondary" onclick="resetReportForm()">
                                        <i class="bi bi-x-circle"></i> Clear
                                    </button>
                                    <button class="btn btn-primary" onclick="generatePrintableReport()">
                                        <i class="bi bi-file-earmark-pdf"></i> Download PDF Report
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-2">
                                    Report data respects role visibility and includes all sites plus per-site detail.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // API Configuration
        const API_BASE = (() => {
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:8000';
            }
            return '/api';
        })();

        console.log('API_BASE configured as:', API_BASE);

        // Global state
        let currentUser = null;
        let charts = {};

        // Auth helpers
        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        // Check authentication
        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            console.log('Checking auth, token exists:', !!token);

            if (!token) {
                console.log('No token found, redirecting to login');
                window.location.href = 'index.html';
                return false;
            }

            try {
                console.log('Fetching user info from', `${API_BASE}/me`);
                const response = await fetch(`${API_BASE}/me`, {
                    headers: getAuthHeaders()
                });

                console.log('Auth response status:', response.status);

                if (response.status === 401) {
                    console.log('Unauthorized, clearing token and redirecting');
                    handleLogout();
                    return false;
                }

                if (!response.ok) {
                    console.error('Auth check failed with status:', response.status);
                    throw new Error(`HTTP ${response.status}`);
                }

                currentUser = await response.json();
                console.log('User authenticated:', currentUser.username, 'Role:', currentUser.role);

                document.getElementById('currentUsername').textContent = currentUser.username;

                // Show users nav item for admins
                if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                    document.getElementById('usersNavItem').style.display = 'block';
                }

                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                alert('Authentication error: ' + error.message + '\nCheck browser console for details.');
                // Don't redirect immediately on error - let user see the error
                return false;
            }
        }

        // Load sites for filter
        async function loadSites() {
            try {
                const response = await fetch(`${API_BASE}/sites`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('siteFilter');

                    data.sites.forEach(site => {
                        const option = document.createElement('option');
                        option.value = site;
                        option.textContent = site;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading sites:', error);
            }
        }

        // Update report scope text based on selected site
        function updateReportScopeText() {
            const site = document.getElementById('siteFilter').value;
            const reportScopeText = document.getElementById('reportScopeText');
            if (site) {
                reportScopeText.textContent = `Generate a date-bound summary for ${site}.`;
            } else {
                reportScopeText.textContent = 'Generate a date-bound summary for all communities.';
            }
        }

        // Load analytics data
        async function loadAnalytics() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('active');

            try {
                const site = document.getElementById('siteFilter').value;
                const url = site
                    ? `${API_BASE}/analytics?site=${encodeURIComponent(site)}`
                    : `${API_BASE}/analytics`;

                // Update report scope text
                updateReportScopeText();

                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleLogout();
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load analytics');
                }

                const data = await response.json();

                // Destroy existing charts
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {};

                // Show/hide agent chart based on role
                if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                    document.getElementById('agentChartContainer').style.display = 'block';
                }

                // Render all charts
                renderLeadsByDay(data.leads_by_day);
                renderSyncStats(data.sync_stats);
                renderLeadsByTimeline(data.leads_by_timeline);
                renderLeadsByPrice(data.leads_by_price);
                renderLeadsBySite(data.leads_by_site);

                if (data.leads_by_agent && data.leads_by_agent.length > 0) {
                    renderLeadsByAgent(data.leads_by_agent);
                }

                renderSummaryStats(data);

            } catch (error) {
                console.error('Error loading analytics:', error);
                alert('Failed to load analytics. Please try again.');
            } finally {
                overlay.classList.remove('active');
            }
        }

        // Chart rendering functions
        function renderLeadsByDay(data) {
            const chartData = data.reverse(); // Show oldest to newest
            const ctx = document.getElementById('leadsByDayChart');

            charts.leadsByDay = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Leads',
                        data: chartData.map(d => d.count),
                        borderColor: '#670038',
                        backgroundColor: 'rgba(103, 0, 56, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    const idx = items[0].dataIndex;
                                    return chartData[idx].date;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function renderSyncStats(data) {
            const ctx = document.getElementById('syncStatsChart');
            const total = data.synced + data.not_synced;

            charts.syncStats = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Synced', 'Pending'],
                    datasets: [{
                        data: [data.synced, data.not_synced],
                        backgroundColor: ['#28a745', '#ffc107'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderLeadsByTimeline(data) {
            const ctx = document.getElementById('leadsByTimelineChart');

            charts.leadsByTimeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.timeline),
                    datasets: [{
                        label: 'Leads',
                        data: data.map(d => d.count),
                        backgroundColor: '#670038',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function renderLeadsByPrice(data) {
            const ctx = document.getElementById('leadsByPriceChart');

            charts.leadsByPrice = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.price_range),
                    datasets: [{
                        label: 'Leads',
                        data: data.map(d => d.count),
                        backgroundColor: '#8a0049',
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function renderLeadsBySite(data) {
            const ctx = document.getElementById('leadsBySiteChart');
            const colors = [
                '#670038', '#8a0049', '#a50062', '#c0007b', '#db0094',
                '#4a0028', '#5a0032', '#6a003c', '#7a0046', '#8a0050'
            ];

            charts.leadsBySite = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(d => d.site),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: colors.slice(0, data.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10
                            }
                        }
                    }
                }
            });
        }

        function renderLeadsByAgent(data) {
            const ctx = document.getElementById('leadsByAgentChart');

            charts.leadsByAgent = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.agent_name),
                    datasets: [{
                        label: 'Leads',
                        data: data.map(d => d.count),
                        backgroundColor: '#670038',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function renderSummaryStats(data) {
            const container = document.getElementById('summaryStats');

            const totalLeads = data.leads_by_day.reduce((sum, d) => sum + d.count, 0);
            const avgPerDay = totalLeads > 0 ? (totalLeads / data.leads_by_day.length).toFixed(1) : 0;
            const syncRate = data.sync_stats.synced + data.sync_stats.not_synced > 0
                ? ((data.sync_stats.synced / (data.sync_stats.synced + data.sync_stats.not_synced)) * 100).toFixed(1)
                : 0;

            const mostPopularTimeline = data.leads_by_timeline.length > 0
                ? data.leads_by_timeline.reduce((max, d) => d.count > max.count ? d : max, data.leads_by_timeline[0])
                : null;

            const mostPopularPrice = data.leads_by_price.length > 0
                ? data.leads_by_price.reduce((max, d) => d.count > max.count ? d : max, data.leads_by_price[0])
                : null;

            container.innerHTML = `
                <div class="col-md-3">
                    <div class="p-3">
                        <h3 class="text-primary">${totalLeads}</h3>
                        <p class="text-muted mb-0">Total Leads (30 days)</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3">
                        <h3 class="text-primary">${avgPerDay}</h3>
                        <p class="text-muted mb-0">Avg. Leads/Day</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3">
                        <h3 class="text-success">${syncRate}%</h3>
                        <p class="text-muted mb-0">CINC Sync Rate</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3">
                        <h3 class="text-info">${mostPopularTimeline ? mostPopularTimeline.count : 0}</h3>
                        <p class="text-muted mb-0">${mostPopularTimeline ? mostPopularTimeline.timeline : 'N/A'}</p>
                    </div>
                </div>
            `;
        }

        function resetReportForm() {
            document.getElementById('reportStartDate').value = '';
            document.getElementById('reportEndDate').value = '';
            setReportError(null);
        }

        function setReportError(message) {
            const errorDiv = document.getElementById('reportError');
            if (!errorDiv) {
                return;
            }

            if (message) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('d-none');
            } else {
                errorDiv.textContent = '';
                errorDiv.classList.add('d-none');
            }
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatDateForReport(value) {
            if (!value) return '';
            return value.replace('T', ' ');
        }

        function renderBreakdownList(items) {
            if (!items || items.length === 0) {
                return '<p class="muted">No data</p>';
            }

            return `
                <ul class="breakdown-list">
                    ${items.map(item => `
                        <li>
                            <span class="label">${escapeHtml(item.label)}</span>
                            <span class="value">${item.count}</span>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        // Colorblind-friendly palette (Okabe-Ito inspired with high contrast)
        const REPORT_COLOR_PALETTE = [
            '#0072B2', // Blue
            '#E69F00', // Orange
            '#009E73', // Bluish green
            '#D55E00', // Vermillion
            '#CC79A7', // Reddish purple
            '#56B4E9', // Sky blue
            '#F0E442', // Yellow
            '#882255', // Dark purple
            '#117733', // Dark green
            '#AA4499'  // Purple
        ];

        function normalizeBreakdown(items) {
            if (!Array.isArray(items)) {
                return [];
            }
            return items
                .filter(item => item && item.label !== undefined && item.label !== null)
                .map(item => ({
                    label: String(item.label),
                    count: Number(item.count) || 0
                }));
        }

        function breakdownHasValues(items) {
            return normalizeBreakdown(items).some(item => item.count > 0);
        }

        // Custom builder colors
        const BUILDER_COLORS = {
            'Bill Beazley Homes': '#009E73',  // Green
            'Beazley': '#009E73',  // Green
            'Pierwood Construction': '#0072B2',  // Blue
            'Pierwood': '#0072B2',  // Blue
            'Crawford Construction': '#F0E442',  // Yellow
            'Crawford': '#F0E442'  // Yellow
        };

        function getPalette(length, labels = []) {
            // Check if this is a builders chart - if so, use custom colors
            const colors = [];
            for (let i = 0; i < length; i++) {
                const label = labels[i];
                // Check if label matches a builder name (case-insensitive partial match)
                let customColor = null;
                if (label) {
                    const labelLower = label.toLowerCase();
                    for (const [builderName, color] of Object.entries(BUILDER_COLORS)) {
                        if (labelLower.includes(builderName.toLowerCase()) ||
                            builderName.toLowerCase().includes(labelLower)) {
                            customColor = color;
                            break;
                        }
                    }
                }
                colors.push(customColor || REPORT_COLOR_PALETTE[i % REPORT_COLOR_PALETTE.length]);
            }
            return colors;
        }

        function toPoints(px) {
            return (px / 96) * 72;
        }

        async function createChartImage({ type, data, options, width = 520, height = 320 }) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                canvas.style.position = 'absolute';
                canvas.style.left = '-9999px';
                document.body.appendChild(canvas);

                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type,
                    data,
                    options: Object.assign({}, options, {
                        animation: false,
                        responsive: false,
                        maintainAspectRatio: false
                    })
                });

                requestAnimationFrame(() => {
                    const dataUrl = canvas.toDataURL('image/png', 1.0);
                    chart.destroy();
                    canvas.remove();
                    resolve({ dataUrl, width, height });
                });
            });
        }

        async function generatePrintableReport() {
            const start = document.getElementById('reportStartDate').value;
            const end = document.getElementById('reportEndDate').value;
            const site = document.getElementById('siteFilter').value;
            const overlay = document.getElementById('loadingOverlay');

            setReportError(null);

            if (!start || !end) {
                setReportError('Please select both a start and end date.');
                return;
            }

            if (end < start) {
                setReportError('End date cannot be earlier than start date.');
                return;
            }

            if (!window.jspdf || typeof window.jspdf.jsPDF !== 'function') {
                setReportError('PDF generator failed to load. Refresh the page and try again.');
                return;
            }

            overlay.classList.add('active');

            try {
                let url = `${API_BASE}/reports/visitors?start_date=${start}&end_date=${end}`;
                if (site) {
                    url += `&site=${encodeURIComponent(site)}`;
                }
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleLogout();
                    return;
                }

                const payload = await response.json();

                if (!response.ok) {
                    const detail = Array.isArray(payload.detail)
                        ? payload.detail.map(d => d.msg).join(', ')
                        : (payload.detail || 'Failed to generate report.');
                    setReportError(detail);
                    return;
                }

                await renderReportPdf(payload, site);
            } catch (error) {
                console.error('Error generating printable report:', error);
                setReportError('Unexpected error generating report. Please try again.');
            } finally {
                overlay.classList.remove('active');
            }
        }

        function buildSiteVisitorTable(site) {
            if (!site.visitors || site.visitors.length === 0) {
                return '<p class="muted">No visitors recorded for this site within the selected dates.</p>';
            }

            const rows = site.visitors.map(visitor => `
                <tr>
                    <td>${escapeHtml(formatDateForReport(visitor.created_at))}</td>
                    <td>${escapeHtml(visitor.buyer_name)}</td>
                    <td>${escapeHtml(visitor.buyer_phone || '')}</td>
                    <td>${escapeHtml(visitor.buyer_email || '')}</td>
                    <td>${escapeHtml(visitor.purchase_timeline)}</td>
                    <td>${escapeHtml(visitor.price_range)}</td>
                    <td>${escapeHtml(visitor.capturing_agent)}</td>
                    <td>${visitor.cinc_synced ? 'Synced' : 'Pending'}</td>
                </tr>
            `).join('');

            return `
                <table class="table table-sm table-bordered report-table">
                    <thead>
                        <tr>
                            <th>Date Logged</th>
                            <th>Buyer</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Timeline</th>
                            <th>Price Range</th>
                            <th>Capturing Agent</th>
                            <th>CINC</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        async function renderReportPdf(report, selectedSite) {
            if (!window.jspdf || typeof window.jspdf.jsPDF !== 'function') {
                setReportError('PDF generator failed to load. Refresh and try again.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const generatedAt = new Date().toLocaleString();
            const overall = report.overall || {};
            const sites = report.sites || [];
            const aggregates = report.aggregates || {};

            const allVisitors = sites.flatMap(site =>
                (site.visitors || []).map(visitor => ({
                    ...visitor,
                    site: site.site || 'Unassigned'
                }))
            );

            const notes = allVisitors
                .filter(visitor => visitor.notes && visitor.notes.trim())
                .map(visitor => ({
                    header: `${visitor.buyer_name || 'Unknown'} • ${visitor.site || 'Unassigned'} • ${visitor.capturing_agent || 'Unassigned'}`,
                    body: visitor.notes.trim()
                }));

            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });

            if (typeof doc.autoTable !== 'function') {
                setReportError('PDF table plugin failed to load. Refresh and try again.');
                return;
            }

            // High contrast colors for accessibility
            const accentColor = [0, 51, 102];  // Dark blue (#003366) - better contrast than cabernet
            const textColor = [0, 0, 0];  // Pure black for maximum contrast
            const mutedColor = [85, 85, 85];  // Darker gray for better readability
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const marginX = 48;
            const marginTop = 60;
            let cursorY = marginTop;

            const filename = `visitor-report-${report.date_range.start}-to-${report.date_range.end}.pdf`;
            doc.setProperties({
                title: 'Visitor Performance Report',
                subject: filename
            });

            function ensureSpace(height) {
                if (cursorY + height > pageHeight - marginTop) {
                    doc.addPage();
                    cursorY = marginTop;
                }
            }

            function addSectionTitle(title) {
                ensureSpace(28);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(...accentColor);
                doc.text(title, marginX, cursorY);
                cursorY += 22;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                doc.setTextColor(...textColor);
            }

            function addHeader() {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(...accentColor);
                doc.text('Visitor Performance Report', marginX, cursorY);
                cursorY += 28;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                doc.setTextColor(...textColor);
                doc.text(`Date Range: ${report.date_range.start} – ${report.date_range.end}`, marginX, cursorY);
                cursorY += 16;
                doc.text(`Generated: ${generatedAt}`, marginX, cursorY);
                cursorY += 16;
                const scopeText = selectedSite ? `Scope: ${selectedSite}` : 'Scope: All accessible sites';
                doc.text(scopeText, marginX, cursorY);
                cursorY += 24;
            }

            addHeader();

            const summaryItems = [
                { label: 'Total Visitors', value: overall.total_visitors || 0 },
                { label: 'CINC Synced', value: overall.cinc_synced || 0 },
                { label: 'Pending CINC', value: overall.not_synced || 0 },
                { label: 'Communities Represented', value: overall.site_count || 0 },
                { label: 'Capturing Agents', value: overall.agent_count || 0 },
            ];

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(13);
            doc.setTextColor(...textColor);

            summaryItems.forEach(item => {
                ensureSpace(18);
                doc.text(`${item.label}: ${item.value}`, marginX, cursorY);
                cursorY += 18;
            });
            cursorY += 12;

            addSectionTitle('Lead Directory');

            if (allVisitors.length === 0) {
                ensureSpace(16);
                doc.text('No visitors were recorded during this period.', marginX, cursorY);
                cursorY += 20;
            } else {
                const leadRows = allVisitors.map((visitor, index) => [
                    index + 1,
                    visitor.buyer_name || '—',
                    visitor.buyer_phone || '—',
                    visitor.buyer_email || '—',
                    visitor.site || '—',
                    visitor.capturing_agent || '—',
                    visitor.created_at ? formatDateForReport(visitor.created_at) : '—'
                ]);

                doc.autoTable({
                    head: [['#', 'Buyer', 'Phone', 'Email', 'Site', 'Agent', 'Logged']],
                    body: leadRows,
                    startY: cursorY,
                    margin: { left: marginX, right: marginX },
                    styles: {
                        fontSize: 12,
                        textColor: textColor,
                        lineColor: [220, 210, 215],
                        lineWidth: 0.5,
                        cellPadding: { top: 4, right: 3, bottom: 4, left: 3 },
                        overflow: 'linebreak'
                    },
                    headStyles: {
                        fillColor: accentColor,
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 12
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240]  // Light gray for better contrast
                    },
                    columnStyles: {
                        0: { cellWidth: 24 },
                        1: { cellWidth: 95 },
                        2: { cellWidth: 65 },
                        3: { cellWidth: 120 },
                        4: { cellWidth: 60 },
                        5: { cellWidth: 85 },
                        6: { cellWidth: 60 }
                    },
                    theme: 'grid',
                    didDrawPage: () => {
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(12);
                        doc.setTextColor(...mutedColor);
                        doc.text(
                            `Visitor Performance Report • ${report.date_range.start} – ${report.date_range.end}`,
                            marginX,
                            36
                        );
                    }
                });

                cursorY = (doc.lastAutoTable && doc.lastAutoTable.finalY)
                    ? doc.lastAutoTable.finalY + 28
                    : cursorY + 28;

                if (cursorY > pageHeight - marginTop) {
                    doc.addPage();
                    cursorY = marginTop;
                }
            }

            addSectionTitle('Key Insights');

            // Transform first_visit data to Yes/No format
            function transformFirstVisitData(breakdown) {
                const normalized = normalizeBreakdown(breakdown);
                return normalized.map(item => {
                    if (item.label.toLowerCase().includes('first') || item.label.toLowerCase() === 'yes') {
                        return { label: 'Yes', count: item.count };
                    } else {
                        return { label: 'No', count: item.count };
                    }
                });
            }

            const chartRequests = [
                { title: 'First Visit to Community?', kind: 'pie', breakdown: transformFirstVisitData(aggregates.first_visit) },
                { title: 'Which product is the buyer interested in?', kind: 'pie', breakdown: normalizeBreakdown(aggregates.interested_in) },
                { title: 'Did the buyer have a Co-broker?', kind: 'pie', breakdown: normalizeBreakdown(aggregates.cobroker) },
                { title: 'Is the Buyer Local?', kind: 'pie', breakdown: normalizeBreakdown(aggregates.local) },
                { title: 'Purchase Timeline', kind: 'pie', breakdown: normalizeBreakdown(aggregates.timeline) },
                { title: 'First learn about the community?', kind: 'bar-horizontal', breakdown: normalizeBreakdown(aggregates.discovery) },
                { title: 'Builders Preference', kind: 'pie', breakdown: normalizeBreakdown(aggregates.builders_requested) },
                {
                    title: 'Deal Progress',
                    kind: 'double-bar',
                    data: {
                        offer: normalizeBreakdown(aggregates.offer_on_table),
                        contracts: normalizeBreakdown(aggregates.finalized_contracts)
                    }
                },
                { title: 'Leads by Site', kind: 'bar-horizontal', breakdown: normalizeBreakdown(aggregates.sites) },
                { title: 'Leads by Agent', kind: 'bar-horizontal', breakdown: normalizeBreakdown(aggregates.agents) },
            ];

            const chartDisplayWidth = 240;
            const chartSpacing = 24;
            const chartOutputs = [];

            for (const request of chartRequests) {
                if (request.kind === 'double-bar') {
                    const offerMap = (request.data.offer || []).reduce((acc, item) => {
                        acc[item.label] = item.count;
                        return acc;
                    }, {});
                    const contractMap = (request.data.contracts || []).reduce((acc, item) => {
                        acc[item.label] = item.count;
                        return acc;
                    }, {});
                    const total = (offerMap.Yes || 0) + (offerMap.No || 0) + (contractMap.Yes || 0) + (contractMap.No || 0);
                    if (total === 0) {
                        chartOutputs.push({ title: request.title, noData: true });
                        continue;
                    }

                    const chartImage = await createChartImage({
                        type: 'bar',
                        width: 640,
                        height: 380,
                        data: {
                            labels: ['Offer on the Table', 'Finalized Contracts'],
                            datasets: [
                                {
                                    label: 'Yes',
                                    data: [offerMap.Yes || 0, contractMap.Yes || 0],
                                    backgroundColor: '#0072B2',  // Blue - colorblind friendly
                                    borderRadius: 6
                                },
                                {
                                    label: 'No',
                                    data: [offerMap.No || 0, contractMap.No || 0],
                                    backgroundColor: '#E69F00',  // Orange - high contrast with blue
                                    borderRadius: 6
                                }
                            ]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: {
                                            size: 20
                                        },
                                        padding: 15
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0,
                                        font: {
                                            size: 18
                                        }
                                    }
                                }
                            }
                        }
                    });

                    chartOutputs.push({
                        title: request.title,
                        dataUrl: chartImage.dataUrl,
                        displayWidth: chartDisplayWidth,
                        displayHeight: chartDisplayWidth * (chartImage.height / chartImage.width)
                    });
                    continue;
                }

                const breakdown = normalizeBreakdown(request.breakdown || []);
                if (!breakdownHasValues(breakdown)) {
                    chartOutputs.push({ title: request.title, noData: true });
                    continue;
                }

                const labels = breakdown.map(item => item.label);
                const counts = breakdown.map(item => item.count);

                if (request.kind === 'pie') {
                    const chartImage = await createChartImage({
                        type: 'pie',
                        width: 640,
                        height: 400,
                        data: {
                            labels,
                            datasets: [{
                                data: counts,
                                backgroundColor: getPalette(labels.length, labels),
                                borderColor: '#ffffff',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: {
                                            size: 20
                                        },
                                        padding: 15
                                    }
                                }
                            }
                        }
                    });

                    chartOutputs.push({
                        title: request.title,
                        dataUrl: chartImage.dataUrl,
                        displayWidth: chartDisplayWidth,
                        displayHeight: chartDisplayWidth * (chartImage.height / chartImage.width)
                    });
                } else if (request.kind === 'bar-horizontal') {
                    const chartImage = await createChartImage({
                        type: 'bar',
                        width: 640,
                        height: 420,
                        data: {
                            labels,
                            datasets: [{
                                label: 'Leads',
                                data: counts,
                                backgroundColor: '#0072B2',  // Blue for accessibility
                                borderRadius: 6
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0,
                                        font: {
                                            size: 18
                                        }
                                    }
                                },
                                y: {
                                    ticks: {
                                        font: {
                                            size: 18
                                        }
                                    }
                                }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });

                    chartOutputs.push({
                        title: request.title,
                        dataUrl: chartImage.dataUrl,
                        displayWidth: chartDisplayWidth,
                        displayHeight: chartDisplayWidth * (chartImage.height / chartImage.width)
                    });
                }
            }

            let chartColumn = 0;
            let rowHeight = 0;
            const chartsPerRow = 2;

            chartOutputs.forEach(output => {
                const estimatedHeight = output.noData ? 60 : output.displayHeight + 28;
                if (chartColumn === 0) {
                    ensureSpace(estimatedHeight + 20);
                }

                const x = marginX + chartColumn * (chartDisplayWidth + chartSpacing);

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(...accentColor);
                doc.text(output.title, x, cursorY);

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                doc.setTextColor(...textColor);

                if (output.noData) {
                    doc.text('No data available for this chart.', x, cursorY + 18);
                    rowHeight = Math.max(rowHeight, 60);
                } else {
                    doc.addImage(output.dataUrl, 'PNG', x, cursorY + 10, output.displayWidth, output.displayHeight);
                    rowHeight = Math.max(rowHeight, output.displayHeight + 32);
                }

                chartColumn += 1;

                if (chartColumn === chartsPerRow) {
                    cursorY += rowHeight + 24;
                    chartColumn = 0;
                    rowHeight = 0;
                }
            });

            if (chartColumn !== 0) {
                cursorY += rowHeight + 24;
            }

            addSectionTitle('Notes');

            if (notes.length === 0) {
                ensureSpace(16);
                doc.text('No notes recorded during this period.', marginX, cursorY);
                cursorY += 20;
            } else {
                notes.forEach(note => {
                    ensureSpace(40);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    doc.setTextColor(...accentColor);
                    doc.text(note.header, marginX, cursorY);
                    cursorY += 14;

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(12);
                    doc.setTextColor(...textColor);
                    const wrapped = doc.splitTextToSize(note.body, pageWidth - marginX * 2);
                    doc.text(wrapped, marginX, cursorY);
                    cursorY += wrapped.length * 14 + 16;
                });
            }

            doc.save(filename);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            const authenticated = await checkAuth();
            if (authenticated) {
                await loadSites();
                await loadAnalytics();
            }
        });
    </script>
</body>
</html>
